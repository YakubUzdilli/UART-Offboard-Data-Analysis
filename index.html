<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>UbiComp Assignment – Offboard</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:900px;margin:24px auto;padding:0 16px}
    button{padding:10px 14px;margin:6px 8px 6px 0}
    label{margin-left:8px}
    #sensordata{width:100%;height:80px}
    #status{display:inline-block;margin-left:8px;font-weight:600}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <script src="model.js"></script>
</head>
<body>
  <h1>Off-board Classification</h1>

  <p>
    <button id="btnConnect">Connect</button>
    <button id="btnFetch" disabled>Fetch 20 samples</button>
    <label><input type="checkbox" id="autoChk" disabled /> Auto (1.6 s)</label>
    <button id="btnDisconnect" disabled>Disconnect</button>
    <span id="status">Not connected</span>
  </p>

  <textarea id="sensordata" placeholder="CSV (60 Zahlen) …"></textarea>
  <div id="result" style="margin-top:1em;font-weight:bold;"></div>
  <canvas id="myChart" style="width:100%;max-width:700px;margin-top:12px;"></canvas>

  <!-- UART.js: WebBluetooth helper -->
  <script src="https://www.espruino.com/js/uart.js"></script>
  <script>
  // ---- UI handles
  const $connect = document.getElementById('btnConnect');
  const $fetch   = document.getElementById('btnFetch');
  const $auto    = document.getElementById('autoChk');
  const $disc    = document.getElementById('btnDisconnect');
  const $status  = document.getElementById('status');
  const $sens    = document.getElementById('sensordata');
  const $result  = document.getElementById('result');

  // ---- State
  let connection = null;
  let autoTimer = null;

  function setConnectedUI(on){
    $fetch.disabled = !on;
    $disc.disabled  = !on;
    $auto.disabled  = !on;
    $connect.disabled = on;
    $status.textContent = on ? "Connected" : "Not connected";
    if (!on) {
      $auto.checked = false;
      if (autoTimer){ clearInterval(autoTimer); autoTimer=null; }
    }
  }

  // ---- CSV -> Array[60 int]
  function extractDataFromResponse(response){
    if (!response || typeof response !== "string") return null;
    const arr = response.split(",")
      .map(s => parseInt(s,10))
      .filter(n => Number.isFinite(n));
    return (arr.length === 60) ? arr : null;
  }

  // ---- Classification & display
  function doClassification(data){
    const out = classify(data); // aus model.js
    const labels = ["random","up-down","sideways"];
    const idx = out.indexOf(Math.max(...out));
    $result.textContent = `Classifier: ${labels[idx]}  (raw=[${out.join(", ")}])`;
  }

  // ---- Plot (optional)
  let chart = null;
  function makeChart(data){
    if (!data) return;
    const xs=[], ys=[], zs=[];
    for (let i=0;i<20;i++){
      xs.push(data[3*i]);
      ys.push(data[3*i+1]);
      zs.push(data[3*i+2]);
    }
    const labels = Array.from({length:20},(_,i)=>i+1);
    if (chart) chart.destroy();
    chart = new Chart("myChart", {
      type: "line",
      data: {
        labels,
        datasets: [
          {label:"x",data:xs,fill:false,borderColor:"red"},
          {label:"y",data:ys,fill:false,borderColor:"green"},
          {label:"z",data:zs,fill:false,borderColor:"blue"}
        ]
      },
      options:{legend:{display:true}}
    });
  }

  // ---- Fetch ohne Verbindung zu schließen
  function fetchOnce(){
    UART.eval('dumpData()', function(response) {
      $sens.value = response || "";
      const data = extractDataFromResponse(response);
      if (!data){
        $result.textContent = "Zu wenig Daten – kurz warten und erneut klicken.";
        return;
      }
      makeChart(data);
      doClassification(data);
    });
  }

  // ---- Events
  $connect.onclick = async () => {
    try{
      connection = await UART.connect();
      // Verbindung offen lassen – NICHT schließen
      setConnectedUI(true);
    }catch(e){
      $status.textContent = "Connect failed: " + e.message;
    }
  };

  $fetch.onclick = () => fetchOnce();

  $auto.onchange = () => {
    if ($auto.checked){
      // alle ~1.6 s (20 Samples @ 12.5 Hz)
      autoTimer = setInterval(fetchOnce, 1600);
      fetchOnce(); // sofort einmal
    }else{
      if (autoTimer){ clearInterval(autoTimer); autoTimer=null; }
    }
  };

  $disc.onclick = () => {
    try{
      if (connection) connection.close();
    }catch(_){}
    connection=null;
    setConnectedUI(false);
  };
  </script>
</body>
</html>
