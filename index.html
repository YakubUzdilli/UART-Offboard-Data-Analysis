<html>
 <head>
   <meta charset="utf-8" />
   <title>UbiComp Assignment – Offboard</title>
 </head>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
 <script src="model.js"></script>
 <body>
   <h1>Off-board Classification</h1>
   <p>
     <button onclick="UART.connect()">Connect</button>
     <button onclick="getData()">Retrieve and process</button>
   </p>
   <textarea id="sensordata" cols="80" rows="4"></textarea>
   <div id="result" style="margin-top:1em;font-weight:bold;"></div>
   <canvas id="myChart" style="width:100%;max-width:700px"></canvas>

   <!-- UART.js: WebBluetooth helper -->
   <script src="https://www.espruino.com/js/uart.js"></script>
   <script>
   function extractDataFromResponse(response){
     // Erwartet CSV-String mit 60 Zahlen
     if (!response || typeof response !== "string") return null;
     const arr = response.split(",")
       .map(s => parseInt(s,10))
       .filter(n => Number.isFinite(n));
     return (arr.length === 60) ? arr : null;
   }

   function doClassification(data){
     // classify() kommt aus model.js
     const out = classify(data);      // -> Array mit 3 Werten [-128..128]
     const labels = ["random","up-down","sideways"];
     const idx = out.indexOf(Math.max(...out));
     document.getElementById("result").textContent =
       `Classifier output: ${labels[idx]}  (raw = [${out.join(", ")}])`;
   }

   var chart = null;
   function makeChart(data){
     if (!data) return;
     // 20 Samples à 3 Achsen = 60 Werte
     const xs = [], ys = [], zs = [];
     for (let i=0;i<20;i++){
       xs.push(data[3*i]);
       ys.push(data[3*i+1]);
       zs.push(data[3*i+2]);
     }
     const labels = Array.from({length:20},(_,i)=>i+1);
     if (chart) chart.destroy();
     chart = new Chart("myChart", {
       type: "line",
       data: {
         labels: labels,
         datasets: [
           {label:"x",data:xs,fill:false,borderColor:"red"},
           {label:"y",data:ys,fill:false,borderColor:"green"},
           {label:"z",data:zs,fill:false,borderColor:"blue"}
         ]
       },
       options: {legend:{display:true}}
     });
   }

   function getData(){
     UART.eval('dumpData()', function(response) {
       document.getElementById("sensordata").value = response || "";
       UART.close();
       const data = extractDataFromResponse(response);
       if (!data){
         document.getElementById("result").textContent="Zu wenig Daten – kurz warten und erneut klicken.";
         return;
       }
       makeChart(data);
       doClassification(data);
     });
   }
   </script>
 </body>
</html>
