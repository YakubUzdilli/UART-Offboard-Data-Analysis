<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Off-board Classification</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:900px;margin:24px auto;padding:0 16px}
    button{padding:10px 14px;margin:6px 8px 6px 0}
    label{margin-left:8px}
    #sensordata{width:100%;height:90px}
    #status{display:inline-block;margin-left:8px;font-weight:600}
    #calInfo{margin-left:8px;font-style:italic}
    canvas{max-width:700px}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <script src="model.js"></script>
</head>
<body>
  <h1>Off-board Classification</h1>

  <p>
    <button id="btnConnect">Connect</button>
    <button id="btnFetch" disabled>Fetch 20 samples</button>
    <label><input type="checkbox" id="autoChk" disabled /> Auto (1.6 s)</label>
    <button id="btnDisconnect" disabled>Disconnect</button>
    <span id="status">Not connected</span>
  </p>

  <p>
    <button id="btnCal" disabled>Calibrate (hold still ~1s)</button>
    <span id="calInfo"></span>
  </p>

  <textarea id="sensordata" placeholder="CSV (60 ints: 20×x,y,z) …"></textarea>
  <div id="result" style="margin-top:8px;font-weight:bold;"></div>
  <canvas id="myChart"></canvas>

  <!-- UART.js: WebBluetooth helper -->
  <script src="https://www.espruino.com/js/uart.js"></script>
  <script>
  // ---- UI refs
  const $connect = document.getElementById('btnConnect');
  const $fetch   = document.getElementById('btnFetch');
  const $auto    = document.getElementById('autoChk');
  const $disc    = document.getElementById('btnDisconnect');
  const $status  = document.getElementById('status');
  const $sens    = document.getElementById('sensordata');
  const $result  = document.getElementById('result');
  const $cal     = document.getElementById('btnCal');
  const $calInfo = document.getElementById('calInfo');

  // ---- State
  let connection = null;
  let autoTimer = null;

  // Calibration offsets (auf Werten in ±127)
  let ox=0, oy=0, oz=0;
  let calMode=false, calN=0, sx=0, sy=0, sz=0;

  function setConnectedUI(on){
    $connect.disabled = on;
    $fetch.disabled   = !on;
    $auto.disabled    = !on;
    $disc.disabled    = !on;
    $cal.disabled     = !on;
    $status.textContent = on ? "Connected" : "Not connected";

    if (!on){
      $auto.checked = false;
      if (autoTimer){ clearInterval(autoTimer); autoTimer=null; }
      $calInfo.textContent = "";
    }
  }

  // ---- Robustes Parsen: extrahiere nur Zahlen, nimm die letzten 60
  function parseCSV60(response){
    if (!response || typeof response !== "string") return null;
    // Entfernt Prompts/Echo (":"/">") usw. – extrahiert nur ints
    const nums = (response.match(/-?\d+/g) || []).map(n => parseInt(n,10));
    if (nums.length < 60) return null;
    // nimm die letzte volle 60er-Sequenz (falls zusätzliches Zeug im String ist)
    const arr = nums.slice(-60);
    return arr.length === 60 ? arr : null;
  }

  // ---- Klassifikation + Anzeige
  function doClassification(data){
    // Kalibrierte Daten anwenden (pro Achse Offsets abziehen)
    const adj = data.slice(); // copy
    for (let i=0;i<20;i++){
      adj[3*i]   = clamp127(adj[3*i]   - ox);
      adj[3*i+1] = clamp127(adj[3*i+1] - oy);
      adj[3*i+2] = clamp127(adj[3*i+2] - oz);
    }
    const out = classify(adj); // kommt aus model.js
    const labels = ["random","up-down","sideways"];
    const idx = out.indexOf(Math.max(...out));
    $result.textContent = `Classifier: ${labels[idx]}  (raw=[${out.join(", ")}])`;
    plotWindow(adj);
  }

  function clamp127(v){ if(v>127)return 127; if(v<-127)return -127; return v|0; }

  // ---- Plot (x/y/z über 20 Samples)
  let chart = null;
  function plotWindow(data){
    const xs=[], ys=[], zs=[];
    for (let i=0;i<20;i++){
      xs.push(data[3*i]);
      ys.push(data[3*i+1]);
      zs.push(data[3*i+2]);
    }
    const labels = Array.from({length:20},(_,i)=>i+1);
    if (chart) chart.destroy();
    chart = new Chart("myChart", {
      type: "line",
      data: {
        labels,
        datasets: [
          {label:"x",data:xs,fill:false,borderColor:"red"},
          {label:"y",data:ys,fill:false,borderColor:"green"},
          {label:"z",data:zs,fill:false,borderColor:"blue"}
        ]
      },
      options:{legend:{display:true}}
    });
  }

  // ---- Einmal 20 Samples vom Puck holen (Verbindung bleibt offen)
  function fetchOnce(){
    UART.eval('dumpData()', function(response) {
      // Textarea updaten
      $sens.value = response || "";
      const data = parseCSV60(response);
      if (!data){
        $result.textContent = "Zu wenig Daten – kurz warten und erneut klicken.";
        return;
      }
      // Wenn gerade Kalibrierung aktiv: Mittel der 60er-Fenster sammeln
      if (calMode){
        let sxw=0, syw=0, szw=0;
        for (let i=0;i<20;i++){
          sxw += data[3*i]; syw += data[3*i+1]; szw += data[3*i+2];
        }
        sx += Math.round(sxw/20);
        sy += Math.round(syw/20);
        sz += Math.round(szw/20);
        calN++;
      }
      doClassification(data);
    });
  }

  // ---- Events
  document.getElementById('btnConnect').onclick = async () => {
    try{
      // Stelle sicher, dass die Espruino Web IDE getrennt ist.
      connection = await UART.connect();
      setConnectedUI(true);
    }catch(e){
      $status.textContent = "Connect failed: " + e.message;
    }
  };

  document.getElementById('btnFetch').onclick = () => fetchOnce();

  document.getElementById('autoChk').onchange = () => {
    if ($auto.checked){
      autoTimer = setInterval(fetchOnce, 1600); // 20 Samples @12.5 Hz
      fetchOnce();
    } else {
      if (autoTimer){ clearInterval(autoTimer); autoTimer=null; }
    }
  };

  document.getElementById('btnDisconnect').onclick = () => {
    try{ if (connection) connection.close(); }catch(_){}
    connection = null;
    setConnectedUI(false);
  };

  // ---- Kalibrierung
  document.getElementById('btnCal').onclick = () => {
    // ~1 s Sammeln (bei Auto kannst du sie anlassen)
    calMode = true; calN=0; sx=sy=sz=0;
    $calInfo.textContent = "Calibrating… keep still";
    setTimeout(()=>{
      if (calN>0){
        ox = Math.round(sx/calN);
        oy = Math.round(sy/calN);
        oz = Math.round(sz/calN);
        $calInfo.textContent = `Offsets set: ox=${ox}, oy=${oy}, oz=${oz}`;
      } else {
        $calInfo.textContent = "Calibration failed (no samples).";
      }
      calMode = false;
    }, 1200);
  };
  </script>
</body>
</html>
